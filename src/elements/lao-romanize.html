<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="lao-styles.html">

<dom-module id="lao-romanize">
  <template>
    <style include="lao-styles">
      :host {
        display: block;
        @apply(--layout-horizontal);
      }

      div {
        padding: 0 5px;
        border-right: 1px solid #CCC;
      }
    </style>

    <template is="dom-repeat" items="[[_output]]">
      <div>[[item]]</div>
    </template>
  </template>

  <script>
    (function () {

      var consonants = {
        'ກ': 'g',
        'ຂ': 'kh',
        'ຄ': 'k',
        'ງ': 'ng',
        'ຈ': 'j',
        'ສ': 's',
        'ຊ': 's',
        'ຍ': 'ny',
        'ດ': 'd',
        'ຕ': 'dt',
        'ຖ': 'th',
        'ທ': 't',
        'ນ': 'n',
        'ບ': 'b',
        'ປ': 'bp',
        'ຜ': 'ph',
        'ຝ': 'f',
        'ພ': 'p',
        'ຟ': 'f',
        'ມ': 'm',
        'ຢ': 'y',
        'ຣ': 'r',
        'ລ': 'l',
        'ວ': 'w',
        'ຫ': 'h',
        'ອ': 'a',
        'ຮ': 'h',
        'ຫງ': 'ng',
        'ຫຍ': 'ny',
        'ໜ': 'n',
        'ໝ': 'm',
        'ຫຼ': 'l',
        'ຫລ': 'l',
        'ຫວ': 'w'
      };

      var vowels = [
        'xະ', 'xັ', 'xາ', 'xາຍ',  'xາວ',
        'xິ', 'xີ', 'xິວ', 'xຶ', 'xື',
        'xຸ', 'xຸຍ', 'xູ',
        'ເxັ', 'ເxະ',  'ເx',
        'ເເxະ', 'ເເx', 'ເເxວ',
        'xົ', 'ໂxະ',  'ໂx', 'ໂxຍ',
        'ເxາະ', 'xໍ', 'xອ', 'xອຍ',
        'ເxິ', 'ເxີ', 'ເxີຍ', 'ເxັຍ', 'ເxຍ', 'ເxັຽ',
        'xຽ', 'xຽວ', 'ເxືອ', 'ເxືອຍ',
        'xົວະ', 'xົວ', 'xວ', 'xວຍ', 'ໃx', 'ໄx',
        'ເxົາ', 'xຳ'
      ];

      var beforeVowelParts = [
        'ເ', 'ໂ', 'ໃ', 'ໄ'
      ];

      var afterVowelParts = [
        'ະ', 'ັ', 'າ', 'ຍ', 'ວ', 'ິ', 'ີ', 'ຶ',
        'ື', 'ຸ', 'ູ', 'ົ', 'ໍ', 'ອ', 'ຽ', 'ຳ'
      ];

      var consonantParts = [
        'ກ', 'ຂ', 'ຄ', 'ງ', 'ຈ', 'ສ', 'ຊ', 'ຍ', 'ດ', 'ຕ',
        'ຖ', 'ທ', 'ນ', 'ບ', 'ປ', 'ຜ', 'ຝ', 'ພ', 'ຟ', 'ມ',
        'ຢ', 'ຣ', 'ລ', 'ວ', 'ຫ', 'ອ', 'ຮ', 'ໜ', 'ໝ', 'ຼ'
      ];

      var toneMarks = [
        '່', '້'
      ];


      var charTypes = {
        INVALID: 0,
        BEFOREVOWEL: 1,
        CONSONANT: 2,
        AFTERVOWEL: 3,
        TONEMARK: 4,
        CONSONANTVOWEL :5
      };

      function charType(c) {
        if (beforeVowelParts.indexOf(c) >= 0) {
          return charTypes.BEFOREVOWEL;
        }
        if (toneMarks.indexOf(c) >= 0) {
          return charTypes.TONEMARK;
        }
        if (consonantParts.indexOf(c) >= 0 && afterVowelParts.indexOf(c) >= 0) {
          return charTypes.CONSONANTVOWEL;
        }
        if (afterVowelParts.indexOf(c) >= 0) {
          return charTypes.AFTERVOWEL;
        }
        if (consonantParts.indexOf(c) >= 0) {
          return charTypes.CONSONANT;
        }
        return charTypes.INVALID;
      }

      function splitParts(input) {
        var chars = input.split('');
        var currentType = charTypes.INVALID;
        var currentPart = '';
        var type;
        var c;
        var split;
        var parts = [];
        for (var i = 0; i < chars.length; i++) {
          c = chars[i];
          type = charType(c);
          split = false;
          if (type === currentType) {
            if (type === charTypes.CONSONANT) {
              if (!consonants[currentPart + c]) {
                split = true;
              }
            }
          } else {
            if (type === charTypes.CONSONANTVOWEL) {
              if (currentType === charTypes.CONSONANT) {
                if (!consonants[currentPart + c]) {
                  split = true;
                  type = charTypes.AFTERVOWEL;
                } else {
                  type = charTypes.CONSONANT;
                }
              } else if (currentType === charTypes.AFTERVOWEL) {
                type = charTypes.AFTERVOWEL;
              } else {
                split = true;
                type = charTypes.CONSONANT;
              }
            } else {
              split = true;
            }
          }

          if (split) {
            if (currentPart !== '') {
              parts.push({
                part: currentPart,
                type: currentType
              });
              currentPart = '';
            }
          }

          currentPart += c;
          currentType = type;
        }
        if (currentPart !== '') {
          parts.push({
            part: currentPart,
            type: currentType
          });
        }

        return parts;
      }

      function joinSyllables(parts) {
        var syllables = [];
        var syllable = [];
        var split = false;
        var addToSplit = false;
        var beforeVowel = false;
        var afterVowel = false;
        var consonant = false;

        for (var i = 0; i < parts.length; i++) {
          split = false;
          addToSplit = false;
          switch(parts[i].type) {
            case charTypes.BEFOREVOWEL:
              if (consonant || afterVowel) {
                split = true;
                addToSplit = false;
                afterVowel = false;
                consonant = false;
              }
              beforeVowel = true;
              break;
            case charTypes.AFTERVOWEL:
            case charTypes.TONEMARK:
              if (!consonant) {
                split = true;
                addToSplit  = true;
                beforeVowel = false;
                afterVowel = false;
                consonant = false;
              } else {
                afterVowel = true;
              }
              break;
            case charTypes.CONSONANT:
              if (consonant) {
                // TODO: determine if final consonant is part of syllable
                split = true;
                addToSplit = false;
                beforeVowel = false;
                afterVowel = false;
              } else if (afterVowel) {
                split = true;
                addToSplit = false;
                beforeVowel = false;
                afterVowel = false;
              }
              consonant = true;
              break;
          }

          if (split) {
            if (addToSplit) {
              syllable.push(parts[i]);
            }
            syllables.push(syllable);
            syllable = [];
          }
          if (!addToSplit) {
            syllable.push(parts[i]);
          }
        }

        if (syllable.length > 0) {
          syllables.push(syllable);
        }

        return syllables;
      }

      function romanizeSyllable(parts) {
        return parts.map(function (part) {
          if (part.type === charTypes.CONSONANT && !!consonants[part.part]) {
            return consonants[part.part];
          }
          return part.part;
        }).join('');
      }

      Polymer({
        is: 'lao-romanize',
        properties: {
          value: String,

          _output: {
            type: Array,
            computed: '_romanize(value)'
          },
        },

        _romanize: function (input) {
          var parts = splitParts(input);
          var syllables = joinSyllables(parts);
          return syllables.map(romanizeSyllable);
        }

      });
    }());
  </script>
</dom-module>
