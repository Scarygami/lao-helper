<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="lao-styles.html">

<dom-module id="lao-romanize">
  <template>
    <style include="lao-styles">
      :host {
        display: block;
        @apply(--layout-horizontal);
      }

      div {
        padding: 0 5px;
        border-right: 1px solid #CCC;
      }
    </style>

    <template is="dom-repeat" items="[[_output]]">
      <div>[[item.text]]<br>[[item.tone]]</div>
    </template>
  </template>

  <script>
    (function () {

      var classes = {
        MID: 1,
        HIGH: 2,
        LOW: 3
      };

      var consonants = {
        'ກ': {char: 'g', charEnd: 'k', class: classes.MID},
        'ຂ': {char: 'kh', charEnd: 'k', class: classes.HIGH},
        'ຄ': {char: 'k', charEnd: 'k', class: classes.LOW},
        'ງ': {char: 'ng', charEnd: 'ng', class: classes.LOW, open: true},
        'ຈ': {char: 'j', charEnd: 'j', class: classes.MID},
        'ສ': {char: 's', charEnd: 's', class: classes.HIGH},
        'ຊ': {char: 's', charEnd: 's', class: classes.LOW},
        'ຍ': {char: 'ny', charEnd: 'y', class: classes.LOW},
        'ດ': {char: 'd', charEnd: 'd', class: classes.MID},
        'ຕ': {char: 'dt', charEnd: 'dt', class: classes.MID},
        'ຖ': {char: 'th', charEnd: 't', class: classes.HIGH},
        'ທ': {char: 't', charEnd: 't', class: classes.LOW},
        'ນ': {char: 'n', charEnd: 'n', class: classes.LOW, open: true},
        'ບ': {char: 'b', charEnd: 'b', class: classes.MID},
        'ປ': {char: 'bp', charEnd: 'bp', class: classes.MID},
        'ຜ': {char: 'ph', charEnd: 'p', class: classes.HIGH},
        'ຝ': {char: 'f', charEnd: 'f', class: classes.HIGH},
        'ພ': {char: 'p', charEnd: 'p', class: classes.LOW},
        'ຟ': {char: 'f', charEnd: 'f', class: classes.LOW},
        'ມ': {char: 'm', charEnd: 'm', class: classes.LOW, open: true},
        'ຢ': {char: 'y', charEnd: 'y', class: classes.MID},
        'ຣ': {char: 'r', charEnd: 'r', class: classes.LOW},
        'ລ': {char: 'l', charEnd: 'l', class: classes.LOW},
        'ວ': {char: 'w', charEnd: 'o', class: classes.LOW},
        'ຫ': {char: 'h', charEnd: 'k', class: classes.HIGH},
        'ອ': {char: ' ', charEnd: 'aw', class: classes.MID},
        'ຮ': {char: 'h', charEnd: 'h', class: classes.LOW},
        'ຫງ': {char: 'ng', charEnd: 'ng', class: classes.HIGH, open: true},
        'ຫຍ': {char: 'ny', charEnd: 'y', class: classes.HIGH},
        'ໜ': {char: 'n', charEnd: 'n', class: classes.HIGH, open: true},
        'ໝ': {char: 'm', charEnd: 'm', class: classes.HIGH, open: true},
        'ຫຼ': {char: 'l', charEnd: 'l', class: classes.HIGH},
        'ຫລ': {char: 'l', charEnd: 'l', class: classes.HIGH},
        'ຫຣ': {char: 'r', charEnd: 'r', class: classes.HIGH},
        'ຫວ': {char: 'w', charEnd: 'o', class: classes.HIGH}
      };

      var vowels = {
        'ະ': {char: 'a', short: true},
        'ັ': {char: 'a', short: true},
        'າ': {char: 'aa'},
        'າຍ': {char: 'aai'},
        'າວ': {char: 'aao'},
        'ິ': {char: ''},
        'ີ': {char: ''},
        'ິວ': {char: ''},
        'ຶ': {char: ''},
        'ື': {char: ''},
        'ຸ': {char: ''},
        'ຸຍ': {char: ''},
        'ູ': {char: ''},
        'ເັ': {char: ''},
        'ເະ': {char: ''},
        'ເ': {char: ''},
        'ເເະ': {char: ''},
        'ເເ': {char: ''},
        'ເເວ': {char: ''},
        'ົ': {char: ''},
        'ໂະ': {char: ''},
        'ໂ': {char: ''},
        'ໂຍ': {char: ''},
        'ເາະ': {char: ''},
        'ໍ': {char: ''},
        'ອ': {char: ''},
        'ອຍ': {char: ''},
        'ເິ': {char: ''},
        'ເີ': {char: ''},
        'ເີຍ': {char: ''},
        'ເັຍ': {char: ''},
        'ເຍ': {char: ''},
        'ເັຽ': {char: ''},
        'ຽ': {char: ''},
        'ຽວ': {char: ''},
        'ເືອ': {char: ''},
        'ເືອຍ': {char: ''},
        'ົວະ': {char: ''},
        'ົວ': {char: ''},
        'ວ': {char: ''},
        'ວຍ': {char: ''},
        'ໃ': {char: ''},
        'ໄ': {char: ''},
        'ເົາ': {char: ''},
        'ຳ': {char: ''}
      };

      var beforeVowelParts = [
        'ເ', 'ໂ', 'ໃ', 'ໄ'
      ];

      var afterVowelParts = [
        'ະ', 'ັ', 'າ', 'ຍ', 'ວ', 'ິ', 'ີ', 'ຶ',
        'ື', 'ຸ', 'ູ', 'ົ', 'ໍ', 'ອ', 'ຽ', 'ຳ'
      ];

      var consonantParts = [
        'ກ', 'ຂ', 'ຄ', 'ງ', 'ຈ', 'ສ', 'ຊ', 'ຍ', 'ດ', 'ຕ',
        'ຖ', 'ທ', 'ນ', 'ບ', 'ປ', 'ຜ', 'ຝ', 'ພ', 'ຟ', 'ມ',
        'ຢ', 'ຣ', 'ລ', 'ວ', 'ຫ', 'ອ', 'ຮ', 'ໜ', 'ໝ', 'ຼ'
      ];

      var toneMarks = [
        '່', '້'
      ];


      var charTypes = {
        INVALID: 0,
        BEFOREVOWEL: 1,
        CONSONANT: 2,
        AFTERVOWEL: 3,
        TONEMARK: 4,
        CONSONANTVOWEL :5
      };

      function charType(c) {
        if (beforeVowelParts.indexOf(c) >= 0) {
          return charTypes.BEFOREVOWEL;
        }
        if (toneMarks.indexOf(c) >= 0) {
          return charTypes.TONEMARK;
        }
        if (consonantParts.indexOf(c) >= 0 && afterVowelParts.indexOf(c) >= 0) {
          return charTypes.CONSONANTVOWEL;
        }
        if (afterVowelParts.indexOf(c) >= 0) {
          return charTypes.AFTERVOWEL;
        }
        if (consonantParts.indexOf(c) >= 0) {
          return charTypes.CONSONANT;
        }
        return charTypes.INVALID;
      }

      function splitParts(input) {
        var chars = input.split('');
        var currentType = charTypes.INVALID;
        var currentPart = '';
        var type;
        var c;
        var split;
        var parts = [];
        for (var i = 0; i < chars.length; i++) {
          c = chars[i];
          type = charType(c);
          split = false;
          if (type === currentType) {
            if (type === charTypes.CONSONANT) {
              if (!consonants[currentPart + c]) {
                split = true;
              }
            }
          } else {
            if (type === charTypes.CONSONANTVOWEL) {
              if (currentType === charTypes.CONSONANT) {
                if (!consonants[currentPart + c]) {
                  split = true;
                  type = charTypes.AFTERVOWEL;
                } else {
                  type = charTypes.CONSONANT;
                }
              } else if (currentType === charTypes.AFTERVOWEL) {
                type = charTypes.AFTERVOWEL;
              } else {
                split = true;
                type = charTypes.CONSONANT;
              }
            } else {
              split = true;
            }
          }

          if (split) {
            if (currentPart !== '') {
              parts.push({
                part: currentPart,
                type: currentType
              });
              currentPart = '';
            }
          }

          currentPart += c;
          currentType = type;
        }
        if (currentPart !== '') {
          parts.push({
            part: currentPart,
            type: currentType
          });
        }

        return parts;
      }

      function joinSyllables(parts) {
        var syllables = [];
        var syllable = [];
        var split = false;
        var addToSplit = false;
        var beforeVowel = false;
        var afterVowel = false;
        var consonant = false;

        for (var i = 0; i < parts.length; i++) {
          split = false;
          addToSplit = false;
          switch(parts[i].type) {
            case charTypes.BEFOREVOWEL:
              if (consonant || afterVowel) {
                split = true;
                addToSplit = false;
                afterVowel = false;
                consonant = false;
              }
              beforeVowel = true;
              break;
            case charTypes.AFTERVOWEL:
            case charTypes.TONEMARK:
              if (!consonant) {
                split = true;
                addToSplit  = true;
                beforeVowel = false;
                afterVowel = false;
                consonant = false;
              } else {
                afterVowel = true;
              }
              break;
            case charTypes.CONSONANT:
              if (consonant) {
                split = true;
                beforeVowel = false;
                afterVowel = false;
                // Determine if final consonant is part of syllable
                // (i.e. followed by other consonant, beforeVowel or end of sentence)
                if ((i === parts.length - 1) || (parts[i + 1].type === charTypes.CONSONANT) || (parts[i + 1].type === charTypes.BEFOREVOWEL)) {
                  addToSplit = true;
                  consonant = false;
                } else {
                  addToSplit = false;
                  consonant = true;
                }
              } else if (afterVowel) {
                split = true;
                addToSplit = false;
                beforeVowel = false;
                afterVowel = false;
                consonant = true;
              } else {
                consonant = true;
              }
              break;
          }

          if (split) {
            if (addToSplit) {
              syllable.push(parts[i]);
            }
            syllables.push(syllable);
            syllable = [];
          }
          if (!addToSplit) {
            syllable.push(parts[i]);
          }
        }

        if (syllable.length > 0) {
          syllables.push(syllable);
        }

        return syllables;
      }

      function romanizeSyllable(parts) {
        var consonantClass = 0;
        var charStart = '';
        var charEnd = '';
        var vowel = '';
        var toneMark = '';
        var openEnd;
        var short;
        var tone = '';

        openEnd = false;
        for (var i = 0; i < parts.length; i++) {
          switch (parts[i].type) {
            case charTypes.CONSONANT:
              if (charStart !== '') {
                charEnd = consonants[parts[i].part].charEnd;
                openEnd = !!consonants[parts[i].part].open;
              } else {
                charStart = consonants[parts[i].part].char;
                consonantClass = consonants[parts[i].part].class;
              }
              break;

            case charTypes.BEFOREVOWEL:
            case charTypes.AFTERVOWEL:
              vowel = vowel + parts[i].part;
              break;
            case charTypes.TONEMARK:
              toneMark = parts[i].part[0];
              break;
          }
        }

        tone = '?';
        if (!!vowels[vowel] && consonantClass !== 0) {
          short = !!vowels[vowel].short;

          if (toneMark === '່') {
            tone = 'Mid';
          } else if (toneMark === '້') {
            if (consonantClass === classes.HIGH) {
              tone = 'Low falling';
            } else {
              tone = 'High falling';
            }
          } else if ((charEnd !== '' && !openEnd) && !short) {
            if (consonantClass === classes.LOW) {
              tone = "High falling";
            } else {
              tone = "Low falling";
            }
          } else if (!openEnd && short) {
            if (consonantClass === classes.LOW) {
              tone = "Mid";
            } else {
              tone = "High";
            }
          } else {
            if (consonantClass === classes.LOW) {
              tone = 'High';
            } else {
              tone = 'Rising';
            }
          }

          vowel = vowels[vowel].char || vowel;
        }

        return {
          text: charStart + vowel + charEnd,
          tone: tone
        };
      }

      Polymer({
        is: 'lao-romanize',
        properties: {
          value: String,

          _output: {
            type: Array,
            computed: '_romanize(value)'
          },
        },

        _romanize: function (input) {
          var parts = splitParts(input);
          var syllables = joinSyllables(parts);
          return syllables.map(romanizeSyllable);
        }

      });
    }());
  </script>
</dom-module>
